import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient("https://TU-PROYECTO.supabase.co", "TU-ANON-KEY");
window.supabase = supabase;

let menu = [];
let envases = [];
let cantidades = {};
let cantidadesEnvases = {};

document.addEventListener("DOMContentLoaded", async () => {
  console.group("ðŸŸ¢ FOCSA â€” InicializaciÃ³n");
  console.log("ðŸš€ Script FOCSA inicializado");

  await cargarMenuEspecial();
  await cargarEnvases();
  inicializarFiltros(menu, envases);

  calcularTotales();
  console.groupEnd();
});

// === Carga de menÃº ===
async function cargarMenuEspecial() {
  console.group("ðŸ“¥ Carga de menÃº");
  const { data, error } = await supabase.rpc("obtener_menu_focsa");
  if (error) {
    console.error("âŒ Error al cargar menÃº:", error);
    console.groupEnd();
    return;
  }
  menu = data || [];
  console.log("âœ… MenÃº cargado:", menu.length, "items");
  renderMenuEspecial(menu);
  console.groupEnd();
}

// === Carga de envases ===
async function cargarEnvases() {
  console.group("ðŸ“¥ Carga de envases");
  const { data, error } = await supabase
    .from("menu_item")
    .select("*")
    .eq("categoria", "Envases")
    .eq("disponible", true)
    .gt("stock", 0)
    .order("precio", { ascending: true });

  if (error) {
    console.error("âŒ Error al cargar envases:", error);
    console.groupEnd();
    return;
  }
  envases = data || [];
  console.log("ðŸ§´ Envases cargados:", envases.length);
  renderEnvases(envases);
  console.groupEnd();
}

// === InicializaciÃ³n de filtros horizontales ===
function inicializarFiltros(menu, envases) {
  console.group("ðŸ”§ InicializaciÃ³n de filtros horizontales");
  const barraFiltros = document.getElementById("barra-filtros");
  barraFiltros.innerHTML = "";

  const categoriasUnicas = [...new Set(menu.map(item => item.categoria))];
  if (!categoriasUnicas.includes("Envases")) categoriasUnicas.push("Envases");

  ["todos", ...categoriasUnicas].forEach(cat => {
    const chip = document.createElement("button");
    chip.className = "filtro-chip";
    chip.textContent = cat;
    chip.dataset.cat = cat;
    chip.onclick = () => {
      document.querySelectorAll(".filtro-chip").forEach(c => c.classList.remove("activo"));
      chip.classList.add("activo");
      filtrarMenu(cat);
    };
    barraFiltros.appendChild(chip);
  });

  console.log("âœ… Filtros generados:", categoriasUnicas);
  console.groupEnd();
}

// === Renderizado en tarjetas ===
function renderGrupoTarjetas(lista, contenedorId, destinoCantidades) {
  console.group(`ðŸ–¼ï¸ Renderizado tarjetas en ${contenedorId}`);
  const contenedor = document.getElementById(contenedorId);
  contenedor.innerHTML = "";

  lista.forEach(item => {
    const card = document.createElement("div");
    card.className = "producto-card";
    card.innerHTML = `
      <h3>${item.nombre}</h3>
      <p>${item.descripcion || ""}</p>
      <div class="precio-agregar">
        <span>${item.precio} CUP</span>
        <input type="number" min="0" value="${destinoCantidades[item.nombre] || 0}"
          data-name
